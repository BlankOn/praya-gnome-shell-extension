#!/bin/sh
set -e

case "$1" in
    configure)
        # Deploy autostart desktop file to existing users
        DESKTOP_FILE="/etc/skel/.config/autostart/praya-extension-update.desktop"
        if [ -f "$DESKTOP_FILE" ]; then
            for HOME_DIR in /home/*; do
                [ -d "$HOME_DIR" ] || continue
                USER_NAME=$(basename "$HOME_DIR")
                # Skip if not a real user (uid >= 1000)
                USER_UID=$(id -u "$USER_NAME" 2>/dev/null) || continue
                [ "$USER_UID" -ge 1000 ] || continue

                AUTOSTART_DIR="$HOME_DIR/.config/autostart"
                mkdir -p "$AUTOSTART_DIR"
                cp "$DESKTOP_FILE" "$AUTOSTART_DIR/"
                chown -R "$USER_NAME":"$USER_NAME" "$HOME_DIR/.config/autostart" || true
            done
        fi

        # Update extension files for currently logged-in users
        for HOME_DIR in /home/*; do
            [ -d "$HOME_DIR" ] || continue
            USER_NAME=$(basename "$HOME_DIR")
            USER_UID=$(id -u "$USER_NAME" 2>/dev/null) || continue
            [ "$USER_UID" -ge 1000 ] || continue
            if loginctl show-user "$USER_NAME" --property=State 2>/dev/null | grep -q "active"; then
                su - "$USER_NAME" -c "/usr/lib/praya-extension/praya-update-user.sh" || true
            fi
        done
        ;;
esac

#DEBHELPER#

exit 0
